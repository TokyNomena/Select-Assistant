<UserControl x:Class="SelectionSet.Views.SelectionOptionsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:SelectionSet.ViewModels"
             xmlns:datatemplate="clr-namespace:SelectionSet.DataTemplates"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:behavior="clr-namespace:SelectionSet.Behaviors"
             xmlns:properties="clr-namespace:SelectionSet.Properties"
             Background="White"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="450">
  <!--
  <d:DesignData.DataContext>
    <vm:SelectionOptionsViewModel/>
  </d:DesignData.DataContext>
  -->  
  <UserControl.Resources>
    <ResourceDictionary>
      <ResourceDictionary.MergedDictionaries>
        <materialDesign:BundledTheme BaseTheme="Light" PrimaryColor="DeepPurple" SecondaryColor="Lime" />
        <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign3.Defaults.xaml" />
        <ResourceDictionary Source="/SelectionSet;component/Styles/GridSplitter.xaml"/>
      </ResourceDictionary.MergedDictionaries>
      <!-- ParameterSelectionFilterTemplate -->
      <DataTemplate x:Key="parameterSelectionFilterTemplate"
                    DataType="vm:ParameterSelectionFilterViewModel">
        <Border Background="White" CornerRadius="4" Padding="6" Margin="2"
                BorderBrush="#E0E0E0" BorderThickness="1">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Vertical" Grid.Column="0">
              <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="{Binding Label}" FontWeight="SemiBold" FontSize="12" 
                           TextTrimming="CharacterEllipsis" />
                <TextBlock Text=" " />
                <TextBlock Text="{Binding FriendlyOwnerScope}" FontSize="10" Foreground="#777"
                           Margin="6 0 0 0" VerticalAlignment="Center"/>
                <TextBlock Text=" • " FontSize="10" Foreground="#AAA" Margin=" 6 0 0 0" VerticalAlignment="Center"/>
                <TextBlock Text="{Binding FriendlyStorageType}" FontSize="10" Foreground="#777" VerticalAlignment="Center"/>
              </StackPanel>

              <TextBlock Text="{Binding ValueAsString}" FontSize="11" Foreground="#333" 
                         TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                         Margin="0 4 0 0"/>
            </StackPanel>

            <!-- compact badge at right for quick scanning -->
            <!--
            <Border Grid.Column="1" Background="#F0F0F0" CornerRadius="12" 
                    Padding="6 2" 
                    Margin="8 0 0 0"
                   VerticalAlignment="Center">
              <TextBlock Text="{Binding ShortValue}" FontSize="11" Foreground="#222" />
            </Border>
            -->
          </Grid>
        </Border>
      </DataTemplate>
      <!-- unknowTemplate -->
      <DataTemplate x:Key="unknowTemplate" DataType="vm:ISelectionFilterViewModel">
        <TextBlock Text="{Binding Label}" Foreground="Red" TextDecorations="Strikethrough"/>
      </DataTemplate>
      <datatemplate:SelectionFilterDataTemplateSelector
        x:Key="selectionTemplateSelector" 
        ParameterSelectionFilter="{StaticResource ResourceKey=parameterSelectionFilterTemplate}"/>
      <!-- General Filter Templates -->
      <datatemplate:GeneralFilterDataTemplateSelector 
        x:Key="generalFilterDataTemplateSelector">
        <datatemplate:GeneralFilterDataTemplateSelector.VisibleOnlyOnActiveViewGeneralFilter>
          <DataTemplate DataType="{x:Type vm:VisibleOnlyOnActiveViewFilter}"/>
        </datatemplate:GeneralFilterDataTemplateSelector.VisibleOnlyOnActiveViewGeneralFilter>
        <datatemplate:GeneralFilterDataTemplateSelector.OnLevelGeneralFilter>
          <DataTemplate DataType="{x:Type vm:OnLevelGeneralFilter}">
            <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
              <ItemsControl ItemsSource="{Binding Levels}" Margin="20 8"
                            Background="White">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" Margin="0 2">
                      <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}" 
                                VerticalAlignment="Center" Margin="0 0 8 0"/>
                      <TextBlock Text="{Binding Data.Item2}" VerticalAlignment="Center"
                                 Style="{StaticResource MaterialDesignBody2TextBlock}"/>
                    </StackPanel>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </DataTemplate>
        </datatemplate:GeneralFilterDataTemplateSelector.OnLevelGeneralFilter>
        <datatemplate:GeneralFilterDataTemplateSelector.ByCategoryGeneralFilter>
          <DataTemplate DataType="{x:Type vm:ByCategoryGeneralFilter}">
            <StackPanel Margin="20 8">
              <!-- Barre de recherche -->
              <TextBox materialDesign:HintAssist.Hint="Rechercher une catégorie..." 
                       Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       Style="{StaticResource MaterialDesignOutlinedTextBox}"
                       Margin="0 0 0 12">
                <TextBox.InputBindings>
                  <KeyBinding Key="Escape" Command="{Binding ClearSearchCommand}"/>
                </TextBox.InputBindings>
              </TextBox>
              <!-- Boutons rapides -->
              <WrapPanel Margin="0 0 0 12">
                <Button Content="{x:Static properties:Resources.LabelSelectEverything}" 
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding SelectAllCategoriesCommand}"
                        Height="28" Padding="8 4" Margin="0 0 4 4" FontSize="11"/>
                <Button Content="{x:Static properties:Resources.LabelDeselectEverything}" 
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding DeselectAllCategoriesCommand}"
                        Height="28" Padding="8 4" Margin="0 0 4 4" FontSize="11"/>
                <Button Content="{x:Static properties:Resources.LabelInvert}" 
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding InvertCategoriesCommand}"
                        Height="28" Padding="8 4" Margin="0 0 4 4" FontSize="11"/>
              </WrapPanel>
              <!-- Liste des catégories sélectionnées (Chips) -->
              <Border BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" 
                      Padding="8" Margin="0 0 0 12" MinHeight="60" MaxHeight="120"
                      Background="#FAFAFA">
                <Border.Style>
                  <Style TargetType="Border">
                    <Setter Property="Visibility" Value="Visible"/>
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding SelectedCategories.Count}" Value="0">
                        <Setter Property="Visibility" Value="Collapsed"/>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </Border.Style>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <ItemsControl ItemsSource="{Binding SelectedCategories}">
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <WrapPanel/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <materialDesign:Chip Content="{Binding Data.Item2}" 
                                             Margin="2"
                                             IsDeletable="True"
                                             DeleteCommand="{Binding DataContext.RemoveCategoryCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                             DeleteCommandParameter="{Binding}"/>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </ScrollViewer>
              </Border>
              <!-- Message si aucune sélection -->
              <TextBlock Text="{x:Static properties:Resources.ThereIsNoCategorySelectioned}" 
                         FontStyle="Italic" FontSize="11" Opacity="0.6"
                         HorizontalAlignment="Center" Margin="0 8">
                <TextBlock.Style>
                  <Style TargetType="TextBlock">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding SelectedCategories.Count}" Value="0">
                        <Setter Property="Visibility" Value="Visible"/>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </TextBlock.Style></TextBlock>
              <!-- Liste scrollable de toutes les catégories -->
              <TextBlock Text="{x:Static properties:Resources.LabelAvailideCategories}"
                         FontWeight="Medium" FontSize="11" Margin="0 0 0 8" Opacity="0.7"/>
              <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding FilteredCategories}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="Transparent" Padding="4 2" Margin="0 1">
                        <Border.InputBindings>
                          <MouseBinding MouseAction="LeftClick" 
                                        Command="{Binding DataContext.ToggleCategoryCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                        CommandParameter="{Binding}"/>
                        </Border.InputBindings>
                        <Border.Style>
                          <Style TargetType="Border">
                            <Style.Triggers>
                              <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#F5F5F5"/>
                                <Setter Property="Cursor" Value="Hand"/>
                              </Trigger>
                            </Style.Triggers>
                          </Style>
                        </Border.Style>
                        <Grid>
                          <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                          </Grid.ColumnDefinitions>
                          <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}" 
                                    VerticalAlignment="Center" Margin="0 0 8 0"
                                    IsHitTestVisible="False"/>
                          <TextBlock Grid.Column="1" Text="{Binding Data.Item2}" 
                                     VerticalAlignment="Center"
                                     Style="{StaticResource MaterialDesignBody2TextBlock}"/>
                          <TextBlock Grid.Column="2" 
                                     Text="{Binding Data.Item3, StringFormat='({0})'}" 
                                     VerticalAlignment="Center" FontSize="10" 
                                     Opacity="0.5" Margin="8 0 0 0"/>
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </StackPanel>
          </DataTemplate>
        </datatemplate:GeneralFilterDataTemplateSelector.ByCategoryGeneralFilter>
        <datatemplate:GeneralFilterDataTemplateSelector.ToRoomSpaceGeneralFilter>
          <DataTemplate DataType="{x:Type vm:ByRoomGeneralFilter}">
            <StackPanel Orientation="Vertical" Margin="20 8">
              <!-- Room Detection Methods -->
              <TextBlock Text="{x:Static properties:Resources.LabelMethodsDetection}" 
                         FontWeight="SemiBold" Margin="0 0 0 8"/>
              <!-- Method 1: Point de calcul -->
              <CheckBox Margin="20 0 0 0" IsChecked="{Binding MethodRoomIsChecked, Mode=TwoWay}"
                        VerticalContentAlignment="Center">
                <StackPanel  Orientation="Horizontal">
                  <TextBlock Text="{x:Static properties:Resources.LabelRoomCalculationPoint}"
                             VerticalAlignment="Center"/>
                  <materialDesign:PackIcon 
                    Kind="HelpCircleOutline" Width="16" Height="16" 
                    Margin="8 0 0 0" Foreground="#666"
                    ToolTip="{x:Static properties:Resources.HelpTextRoomCalculationPointMethod}"
                    VerticalAlignment="Center"/>
                </StackPanel>
              </CheckBox>
              <!-- Method 2: Portes et fenêtres (avec sous-options) -->
              <StackPanel Orientation="Vertical" Margin="0 4">
                <TextBlock Text="{x:Static properties:Resources.LabelDoorsAndWindow}" 
                           FontWeight="Medium" Margin="0 2 0 4"/>
                <StackPanel Margin="20 0 0 0" Orientation="Vertical">
                  <CheckBox IsChecked="{Binding MethodToRoomIsChecked, Mode=TwoWay}" 
                            VerticalContentAlignment="Center" Margin="0 2">
                    <StackPanel Orientation="Horizontal">
                      <TextBlock Text="À la pièce" VerticalAlignment="Center"/>
                      <materialDesign:PackIcon Kind="HelpCircleOutline" Width="14" Height="14" 
                                               Margin="6 0 0 0" Foreground="#666"
                                               ToolTip="{x:Static properties:Resources.HelpTextMethodToRoom}"
                                               VerticalAlignment="Center"/>
                    </StackPanel>
                  </CheckBox>
                  <CheckBox IsChecked="{Binding MethodFromRoomIsChecked, Mode=TwoWay}" 
                            VerticalContentAlignment="Center" Margin="0 2">
                    <StackPanel Orientation="Horizontal">
                      <TextBlock Text="{x:Static properties:Resources.LabelFromRoom}" VerticalAlignment="Center"/>
                      <materialDesign:PackIcon Kind="HelpCircleOutline" Width="14" Height="14" 
                                               Margin="6 0 0 0" Foreground="#666"
                                               ToolTip="{x:Static properties:Resources.HelpTextFromRoomMethod}"
                                               VerticalAlignment="Center"/>
                    </StackPanel>
                  </CheckBox>
                </StackPanel>
              </StackPanel>
              <!-- Method 3: Contact géométrique (avec sous-options) -->
              <StackPanel Orientation="Vertical">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="{x:Static properties:Resources.LabelGeometricContactMethod}"
                             VerticalAlignment="Center"/>
                  <materialDesign:PackIcon Kind="HelpCircleOutline" Width="16" Height="16" 
                                           Margin="8 0 0 0" Foreground="#666"
                                           ToolTip="{x:Static properties:Resources.HelpTextLabelGeometricContactMethod}"/>
                </StackPanel>
                <!-- Sous-options contact géométrique -->
                <StackPanel Margin="20 0 0 0" Orientation="Vertical">
                  <CheckBox IsChecked="{Binding FullCollisionContact, Mode=TwoWay}" 
                            Content="{x:Static properties:Resources.LabelFullCollisionContact}" 
                            Margin="0 2" FontSize="11"/>
                  <CheckBox IsChecked="{Binding SurfacicCollisionContact, Mode=TwoWay}" 
                            Content="{x:Static properties:Resources.LabelSurfacicCollisionContact}" 
                            Margin="0 2" FontSize="11"/>
                </StackPanel>
              </StackPanel>
              <!-- Room Selection -->
              <Separator Margin="0 12"/>
              <TextBlock Text="{x:Static properties:Resources.LabelSelectRooms}" 
                         FontWeight="SemiBold" Margin="0 8"/>
              <Grid Margin="0 8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Button Grid.Column="0" Margin="0 0 4 0"
                        Content="{x:Static properties:Resources.LabelChoiceRooms}" 
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding SelectRoomsCommand}"/>
                <Button Grid.Column="1" Margin="4 0 0 0"
                        Content="{x:Static properties:Resources.LabelDeleteAll}"
                        Style="{StaticResource MaterialDesignOutlinedButton}"
                        Command="{Binding ClearRoomsCommand}"/>
              </Grid>
              <ScrollViewer MaxHeight="120" VerticalScrollBarVisibility="Auto" Margin="0 8">
                <ItemsControl ItemsSource="{Binding Rooms}">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <materialDesign:Chip Content="{Binding Item2}" Margin="2"
                                           IsDeletable="False"/>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel IsItemsHost="True"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                </ItemsControl>
              </ScrollViewer>
            </StackPanel>
          </DataTemplate>
        </datatemplate:GeneralFilterDataTemplateSelector.ToRoomSpaceGeneralFilter>
      </datatemplate:GeneralFilterDataTemplateSelector>
      <BorderGapMaskConverter x:Key="BorderGapMaskConverter"/>
    </ResourceDictionary>
  </UserControl.Resources>
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>
    <!-- TOP BAR: Instructions & Actions -->
    <materialDesign:ColorZone Mode="PrimaryMid" Padding="12 8" Grid.Row="0">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
          <materialDesign:PackIcon Kind="FilterOutline" Width="20" Height="20" 
                                   Foreground="White" Margin="0 0 8 0"/>
          <TextBlock Text="{x:Static properties:Resources.Header}"
                     FontSize="16" FontWeight="SemiBold" 
                     Foreground="White" VerticalAlignment="Center"/>
        </StackPanel>
        <Button Grid.Column="1" Style="{StaticResource MaterialDesignIconButton}"
                Command="{Binding ShowAboutDialogCommand}"
                ToolTip="{x:Static properties:Resources.LabelAboutThisPlugin}" 
                Foreground="White">
          <materialDesign:PackIcon Kind="InformationOutline"/>
        </Button>
      </Grid>
    </materialDesign:ColorZone>
    <!-- MAIN CONTENT AREA -->
    <Grid Grid.Row="1">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" MinWidth="200"/>
        <ColumnDefinition Width="Auto"/>
        <ColumnDefinition Width="1.2*" MinWidth="220"/>
      </Grid.ColumnDefinitions>
      <!-- LEFT PANEL: Critères de Filtrage -->
      <DockPanel Grid.Column="0">
        <StackPanel DockPanel.Dock="Top" Orientation="Vertical" Margin="8">
          <TextBlock Text="{x:Static properties:Resources.CriteriaFiltersTitle}" 
                     FontWeight="SemiBold" FontSize="13" Margin="0 0 0 8"/>
          <!-- Action Buttons -->
          <UniformGrid Columns="3" Margin="0 0 0 8">
            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding TakeSampleCommand}"
                    ToolTip="{x:Static properties:Resources.LabelCopyParametersFromSampleElement}"
                    Padding="4" Margin="2">
              <StackPanel Orientation="Vertical">
                <materialDesign:PackIcon Kind="Eyedropper" HorizontalAlignment="Center" Width="20" Height="20"/>
                <TextBlock Text="Copier" HorizontalAlignment="Center" 
                           Style="{StaticResource MaterialDesignCaptionTextBlock}"/>
              </StackPanel>
            </Button>
            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding DeleteSelectedFilter}"
                    ToolTip="{x:Static properties:Resources.LabelEraseSelectedFilters}"
                    Padding="4" Margin="2">
              <StackPanel Orientation="Vertical">
                <materialDesign:PackIcon Kind="DeleteOutline" HorizontalAlignment="Center" Width="20" Height="20"/>
                <TextBlock Text="{x:Static properties:Resources.LabelErase}"
                           HorizontalAlignment="Center" 
                           Style="{StaticResource MaterialDesignCaptionTextBlock}"/>
              </StackPanel>
            </Button>
            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding DeleteAllFilters}"
                    ToolTip="{x:Static properties:Resources.LabelEraseAllCriteria}"
                    Padding="4" Margin="2">
              <StackPanel Orientation="Vertical">
                <materialDesign:PackIcon Kind="DeleteSweepOutline" HorizontalAlignment="Center" Width="20" Height="20"/>
                <TextBlock Text="{x:Static properties:Resources.LabelEmptyAll}" HorizontalAlignment="Center" 
                           Style="{StaticResource MaterialDesignCaptionTextBlock}"/>
              </StackPanel>
            </Button>
          </UniformGrid>
        </StackPanel>
        <!-- Filter List -->
        <Grid>
          <!-- Empty State -->
          <StackPanel Orientation="Vertical" 
                      VerticalAlignment="Center"
                      HorizontalAlignment="Center"
                      Margin="20">
            <materialDesign:PackIcon Kind="FilterOffOutline" HorizontalAlignment="Center" 
                                     Width="48" Height="48" Foreground="#BDBDBD"/>
            <TextBlock Text="{x:Static properties:Resources.LabelNoFilters}" FontWeight="SemiBold" 
                       HorizontalAlignment="Center" Foreground="#757575" Margin="0 8 0 4"/>
            <TextBlock Text="{x:Static properties:Resources.HelpTextEmptyFilters}" 
                       TextAlignment="Center" TextWrapping="Wrap"
                       Foreground="#9E9E9E" FontSize="11" MaxWidth="150"/>
            <StackPanel.Style>
              <Style TargetType="StackPanel">
                <Setter Property="Visibility" Value="Collapsed"/>
                <Style.Triggers>
                  <DataTrigger Binding="{Binding Filters.Count}" Value="0">
                    <Setter Property="Visibility" Value="Visible"/>
                  </DataTrigger>
                </Style.Triggers>
              </Style>
            </StackPanel.Style>
          </StackPanel>
          <!-- Filter List -->
          <DockPanel>
            <TextBlock DockPanel.Dock="Top" Margin="12 8" FontSize="11" Foreground="#666"
                       Text="{x:Static properties:Resources.LabelRemarkCriteria}">
              <TextBlock.Style>
                <Style TargetType="TextBlock">
                  <Setter Property="Visibility" Value="Visible"/>
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Filters.Count}" Value="0">
                      <Setter Property="Visibility" Value="Collapsed"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </TextBlock.Style></TextBlock>
            <ListBox ItemsSource="{Binding Filters}"
                     ItemTemplateSelector="{StaticResource selectionTemplateSelector}"
                     SelectionMode="Extended"
                     behavior:ListBoxBehavior.SelectedItems="{Binding SelectedFilters, Mode=TwoWay}"
                     BorderThickness="0" Padding="8">
              <ListBox.InputBindings>
                <KeyBinding Key="Delete" Command="{Binding Path=DeleteSelectedFilter}"/>
              </ListBox.InputBindings>
              <ListBox.Style>
                <Style TargetType="ListBox" BasedOn="{StaticResource MaterialDesignListBox}">
                  <Setter Property="Visibility" Value="Visible"/>
                  <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                  <Style.Triggers>
                    <DataTrigger Binding="{Binding Filters.Count}" Value="0">
                      <Setter Property="Visibility" Value="Collapsed"/>
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </ListBox.Style>
            </ListBox>
          </DockPanel>
        </Grid>
      </DockPanel>
      <!-- SPLITTER -->
      <GridSplitter Style="{DynamicResource MAUGridSplitterVerticalStyle}" 
                    Grid.Column="1" Width="5" HorizontalAlignment="Stretch"/>
      <!-- RIGHT PANEL: Scope Options -->
      <DockPanel Grid.Column="2" Background="#FAFAFA">
        <StackPanel DockPanel.Dock="Top" Orientation="Vertical" Margin="12 8">
          <TextBlock Text="{x:Static properties:Resources.LabelSearchField}" 
                     FontWeight="SemiBold" FontSize="13" Margin="0 0 0 4"/>
          <TextBlock Text="{x:Static properties:Resources.HelpTextSearchField}" 
                     FontSize="11" Foreground="#666" TextWrapping="Wrap"/>
        </StackPanel>
        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
          <ItemsControl ItemsSource="{Binding PreElementsFilter}" Margin="8">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <materialDesign:Card Margin="4 4" Padding="0">
                  <StackPanel Orientation="Vertical">
                    <CheckBox x:Name="isActiveCheckbox" 
                              IsChecked="{Binding IsActive}" 
                              Content="{Binding Filter.Title}"
                              Margin="12 8"
                              FontWeight="Medium"/>
                    <ContentPresenter x:Name="mainContentFilter" 
                                      Content="{Binding Filter}" 
                                      ContentTemplateSelector="{StaticResource generalFilterDataTemplateSelector}">
                      <ContentPresenter.Style>
                        <Style TargetType="ContentPresenter">
                          <Setter Property="Visibility" Value="Collapsed"/>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding ElementName=isActiveCheckbox, Path=IsChecked}" Value="true">
                              <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </ContentPresenter.Style>
                    </ContentPresenter>
                  </StackPanel>
                </materialDesign:Card>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </DockPanel>
    </Grid>
    <!-- BOTTOM BAR: Action Buttons -->
    <materialDesign:ColorZone Mode="PrimaryLight" Grid.Row="2" Padding="8">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <!-- Match Count (placeholder for future enhancement) -->
        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
          <materialDesign:PackIcon Kind="CheckCircleOutline" Width="18" Height="18" 
                                   Margin="4 0 8 0" VerticalAlignment="Center"/>
          <TextBlock Text="{x:Static properties:Resources.LabelReadyToSelect}"
                     VerticalAlignment="Center" FontSize="12"/>
          <!-- TODO: Add live count binding: Text="{Binding MatchCount, StringFormat='{0} éléments correspondent'}" -->
        </StackPanel>
        <!-- Action Buttons -->
        <UniformGrid Grid.Column="1" Columns="4" Rows="1">
          <Button Command="{Binding ManualSelectionCommand}" Margin="4 0"
                  Style="{StaticResource MaterialDesignOutlinedButton}"
                  ToolTip="{x:Static properties:Resources.LabelManualSelection}">
            <StackPanel Orientation="Horizontal">
              <materialDesign:PackIcon Kind="VectorRectangle" Margin="0 0 4 0"
                                       VerticalAlignment="Center"/>
              <TextBlock Text="{x:Static properties:Resources.LabelManual}" VerticalAlignment="Center"/>
            </StackPanel>
          </Button>
          <Button Command="{Binding NewSelectionCommand}" Margin="4 0"
                  Style="{StaticResource MaterialDesignRaisedButton}"
                  ToolTip="{x:Static properties:Resources.TooltipReplaceSelection}">
            <StackPanel Orientation="Horizontal">
              <materialDesign:PackIcon Kind="CheckAll" Margin="0 0 4 0"/>
              <TextBlock Text="Sélectionner"/>
            </StackPanel>
          </Button>
          <Button Command="{Binding AddToSelectionCommand}" 
                  Margin="4 0"
                  Style="{StaticResource MaterialDesignOutlinedButton}"
                  ToolTip="{x:Static properties:Resources.TooltipAddToCurrentSelection}">
            <StackPanel Orientation="Horizontal">
              <materialDesign:PackIcon Kind="PlusCircleOutline" Margin="0 0 4 0"/>
              <TextBlock Text="{x:Static properties:Resources.LabelAdd}"/>
            </StackPanel>
          </Button>
          <Button Command="{Binding RemoveSelectionCommand}" 
                  Margin="4 0"
                  Style="{StaticResource MaterialDesignOutlinedButton}"
                  ToolTip="{x:Static properties:Resources.ToolTipRemoveSelected}">
            <StackPanel Orientation="Horizontal">
              <materialDesign:PackIcon Kind="MinusCircleOutline" Margin="0 0 4 0"/>
              <TextBlock Text="{x:Static properties:Resources.LabelRemove}"/>
            </StackPanel>
          </Button>
        </UniformGrid>
      </Grid>
    </materialDesign:ColorZone>
    <!-- Snackbar - Show number of elements selected -->
    <materialDesign:Snackbar Grid.Row="2"
                             MessageQueue="{Binding SnackbarMessageQueue}"
                             VerticalAlignment="Bottom"
                             HorizontalAlignment="Stretch"
                             Background="{DynamicResource MaterialDesign.Brush.Secondary}"
                             HorizontalContentAlignment="Center"
                             Foreground="Black"/>
  </Grid>
</UserControl>